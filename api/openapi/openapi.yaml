openapi: 3.0.3
info:
  title: Family App API
  version: 0.1.0
  description: API for family-app backend.
servers:
  - url: http://localhost:8080
paths:
  /health:
    get:
      summary: Healthcheck
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
  /auth/me:
    get:
      summary: Get current user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /analytics/summary:
    get:
      summary: Analytics summary
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: currency
          schema:
            type: string
        - in: query
          name: tag_ids
          schema:
            type: string
        - in: query
          name: timezone
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsSummary'
  /analytics/timeseries:
    get:
      summary: Analytics timeseries
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: group_by
          required: true
          schema:
            type: string
            enum: [day, week, month]
        - in: query
          name: currency
          schema:
            type: string
        - in: query
          name: tag_ids
          schema:
            type: string
        - in: query
          name: timezone
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AnalyticsTimeseriesPoint'
  /analytics/by-tag:
    get:
      summary: Analytics by tag
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: currency
          schema:
            type: string
        - in: query
          name: tag_ids
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AnalyticsByTagRow'
  /reports/monthly:
    get:
      summary: Monthly report
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from_month
          required: true
          schema:
            type: string
        - in: query
          name: to_month
          required: true
          schema:
            type: string
        - in: query
          name: currency
          schema:
            type: string
        - in: query
          name: tag_ids
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReportsMonthlyRow'
  /reports/compare:
    get:
      summary: Compare two periods
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from_a
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to_a
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: from_b
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to_b
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: currency
          schema:
            type: string
        - in: query
          name: tag_ids
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportsCompareResponse'
  /families/me:
    get:
      summary: Get current family
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Family'
        '404':
          $ref: '#/components/responses/FamilyNotFound'
    patch:
      summary: Update family name
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFamilyRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Family'
  /families:
    post:
      summary: Create family
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFamilyRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Family'
        '409':
          $ref: '#/components/responses/AlreadyInFamily'
  /families/join:
    post:
      summary: Join family by code
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinFamilyRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Family'
        '404':
          $ref: '#/components/responses/FamilyCodeNotFound'
        '409':
          $ref: '#/components/responses/AlreadyInFamily'
  /families/leave:
    post:
      summary: Leave family
      security:
        - bearerAuth: []
      responses:
        '204':
          description: No Content
        '404':
          $ref: '#/components/responses/FamilyNotFound'
  /families/me/members:
    get:
      summary: List family members
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FamilyMember'
  /families/me/members/{user_id}:
    delete:
      summary: Remove family member
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
        '403':
          $ref: '#/components/responses/NotOwner'
        '404':
          $ref: '#/components/responses/MemberNotFound'
        '409':
          $ref: '#/components/responses/CannotRemoveOwner'
  /expenses:
    get:
      summary: List expenses
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from
          schema:
            type: string
            format: date
        - in: query
          name: to
          schema:
            type: string
            format: date
        - in: query
          name: tag_id
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpenseList'
    post:
      summary: Create expense
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExpenseRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expense'
  /expenses/{id}:
    put:
      summary: Update expense
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateExpenseRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expense'
    delete:
      summary: Delete expense
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
  /tags:
    get:
      summary: List tags
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'
    post:
      summary: Create tag
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
  /tags/{id}:
    delete:
      summary: Delete tag
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
  /todo-lists:
    get:
      summary: List todo lists
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
        - in: query
          name: include_items
          schema:
            type: boolean
            default: false
        - in: query
          name: items_archived
          schema:
            type: string
            enum: [exclude, only, all]
            default: exclude
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoListList'
    post:
      summary: Create todo list
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTodoListRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoList'
  /todo-lists/{list_id}:
    patch:
      summary: Update todo list
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: list_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTodoListRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoList'
        '404':
          $ref: '#/components/responses/TodoListNotFound'
    delete:
      summary: Delete todo list
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: list_id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
        '404':
          $ref: '#/components/responses/TodoListNotFound'
  /todo-lists/{list_id}/items:
    get:
      summary: List todo items
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: list_id
          required: true
          schema:
            type: string
        - in: query
          name: archived
          schema:
            type: string
            enum: [exclude, only, all]
            default: exclude
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoItemList'
        '404':
          $ref: '#/components/responses/TodoListNotFound'
    post:
      summary: Create todo item
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: list_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTodoItemRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoItem'
        '404':
          $ref: '#/components/responses/TodoListNotFound'
  /todo-items/{item_id}:
    patch:
      summary: Update todo item
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTodoItemRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodoItem'
        '404':
          $ref: '#/components/responses/TodoItemNotFound'
    delete:
      summary: Delete todo item
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
        '404':
          $ref: '#/components/responses/TodoItemNotFound'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: invalid_token
              message: Invalid token
    FamilyNotFound:
      description: Family not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: family_not_found
              message: Family not found
    FamilyCodeNotFound:
      description: Family code not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: family_code_not_found
              message: Family code not found
    AlreadyInFamily:
      description: Already in family
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: already_in_family
              message: Already in family
    NotOwner:
      description: Not owner
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: not_owner
              message: Only owner can remove members
    MemberNotFound:
      description: Member not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: member_not_found
              message: Member not found
    CannotRemoveOwner:
      description: Cannot remove owner
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: cannot_remove_owner
              message: Cannot remove owner
    TodoListNotFound:
      description: Todo list not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: todo_list_not_found
              message: Todo list not found
    TodoItemNotFound:
      description: Todo item not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: todo_item_not_found
              message: Todo item not found
  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
    AuthMeResponse:
      type: object
      required: [id]
      properties:
        id:
          type: string
        email:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
    Family:
      type: object
      required: [id, name, code, owner_id, created_at]
      properties:
        id:
          type: string
        name:
          type: string
        code:
          type: string
        owner_id:
          type: string
        created_at:
          type: string
          format: date-time
    FamilyMember:
      type: object
      required: [user_id, role, joined_at]
      properties:
        user_id:
          type: string
        role:
          type: string
          enum: [owner, member]
        joined_at:
          type: string
          format: date-time
        email:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
    Expense:
      type: object
      required: [id, family_id, user_id, date, amount, currency, title, tag_ids, created_at, updated_at]
      properties:
        id:
          type: string
        family_id:
          type: string
        user_id:
          type: string
        date:
          type: string
          format: date
        amount:
          type: number
        currency:
          type: string
        title:
          type: string
        tag_ids:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    ExpenseList:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Expense'
        total:
          type: integer
    Tag:
      type: object
      required: [id, name, created_at]
      properties:
        id:
          type: string
        name:
          type: string
        created_at:
          type: string
          format: date-time
    TodoList:
      type: object
      required: [id, family_id, title, created_at, settings, items_total, items_completed, items_archived]
      properties:
        id:
          type: string
        family_id:
          type: string
        title:
          type: string
        created_at:
          type: string
          format: date-time
        settings:
          $ref: '#/components/schemas/TodoListSettings'
        items_total:
          type: integer
        items_completed:
          type: integer
        items_archived:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/TodoItem'
    TodoListSettings:
      type: object
      required: [archive_completed]
      properties:
        archive_completed:
          type: boolean
    TodoItem:
      type: object
      required: [id, list_id, title, is_completed, is_archived, created_at]
      properties:
        id:
          type: string
        list_id:
          type: string
        title:
          type: string
        is_completed:
          type: boolean
        is_archived:
          type: boolean
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        completed_by:
          allOf:
            - $ref: '#/components/schemas/TodoCompletedBy'
          nullable: true
    TodoCompletedBy:
      type: object
      required: [id, name, email]
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        avatar_url:
          type: string
          nullable: true
    TodoListList:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TodoList'
        total:
          type: integer
    TodoItemList:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TodoItem'
        total:
          type: integer
    AnalyticsSummary:
      type: object
      required: [total_amount, currency, count, avg_per_day, from, to]
      properties:
        total_amount:
          type: number
        currency:
          type: string
        count:
          type: integer
        avg_per_day:
          type: number
        from:
          type: string
          format: date
        to:
          type: string
          format: date
    AnalyticsTimeseriesPoint:
      type: object
      required: [period, total, count]
      properties:
        period:
          type: string
        total:
          type: number
        count:
          type: integer
    AnalyticsByTagRow:
      type: object
      required: [tag_id, tag_name, total, count]
      properties:
        tag_id:
          type: string
        tag_name:
          type: string
        total:
          type: number
        count:
          type: integer
    ReportsMonthlyRow:
      type: object
      required: [month, total, count]
      properties:
        month:
          type: string
        total:
          type: number
        count:
          type: integer
    ReportsCompareResponse:
      type: object
      required: [period_a, period_b, delta]
      properties:
        period_a:
          $ref: '#/components/schemas/ReportsComparePeriod'
        period_b:
          $ref: '#/components/schemas/ReportsComparePeriod'
        delta:
          $ref: '#/components/schemas/ReportsDelta'
    ReportsComparePeriod:
      type: object
      required: [from, to, total, count]
      properties:
        from:
          type: string
          format: date
        to:
          type: string
          format: date
        total:
          type: number
        count:
          type: integer
    ReportsDelta:
      type: object
      required: [amount, percent]
      properties:
        amount:
          type: number
        percent:
          type: number
    CreateFamilyRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
    JoinFamilyRequest:
      type: object
      required: [code]
      properties:
        code:
          type: string
    UpdateFamilyRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
    CreateExpenseRequest:
      type: object
      required: [date, amount, currency, title]
      properties:
        date:
          type: string
          format: date
        amount:
          type: number
        currency:
          type: string
        title:
          type: string
        tag_ids:
          type: array
          items:
            type: string
    UpdateExpenseRequest:
      type: object
      required: [date, amount, currency, title]
      properties:
        date:
          type: string
          format: date
        amount:
          type: number
        currency:
          type: string
        title:
          type: string
        tag_ids:
          type: array
          items:
            type: string
    CreateTagRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
    CreateTodoListRequest:
      type: object
      required: [title]
      properties:
        title:
          type: string
        settings:
          $ref: '#/components/schemas/TodoListSettings'
    UpdateTodoListRequest:
      type: object
      properties:
        title:
          type: string
        settings:
          $ref: '#/components/schemas/TodoListSettings'
    CreateTodoItemRequest:
      type: object
      required: [title]
      properties:
        title:
          type: string
    UpdateTodoItemRequest:
      type: object
      properties:
        title:
          type: string
        is_completed:
          type: boolean
